ğŸ“± Mibu å‰ç«¯å•Ÿå‹•åŒ…
## ç’°å¢ƒè¨­å®š
### API Base URL
```typescript
const API_BASE_URL = {
  development: 'https://591965a7-25f6-479c-b527-3890b1193c21-00-1m08cwv9a4rev.picard.replit.dev',
  production: 'https://gacha-travel--s8869420.replit.app'
};
èªè­‰æµç¨‹
Apple Sign In
// 1. ä½¿ç”¨ expo-apple-authentication å–å¾— identityToken
import * as AppleAuthentication from 'expo-apple-authentication';
const credential = await AppleAuthentication.signInAsync({
  requestedScopes: [
    AppleAuthentication.AppleAuthenticationScope.EMAIL,
    AppleAuthentication.AppleAuthenticationScope.FULL_NAME,
  ],
});
// 2. ç™¼é€çµ¦å¾Œç«¯æ›å– JWT
const response = await fetch(`${API_BASE_URL}/api/auth/apple`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ identityToken: credential.identityToken })
});
const { token, user } = await response.json();
// 3. å„²å­˜ Token (SecureStore)
import * as SecureStore from 'expo-secure-store';
await SecureStore.setItemAsync('jwt_token', token);
JWT ä½¿ç”¨æ–¹å¼
// æ‰€æœ‰ API è«‹æ±‚éƒ½éœ€å¸¶å…¥ Authorization Header
const token = await SecureStore.getItemAsync('jwt_token');
const response = await fetch(`${API_BASE_URL}/api/xxx`, {
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  }
});
// Token éæœŸ (401) æ™‚ï¼Œå°å‘é‡æ–°ç™»å…¥
if (response.status === 401) {
  await SecureStore.deleteItemAsync('jwt_token');
  navigation.navigate('Login');
}
JWT çµæ§‹
interface JWTPayload {
  userId: string;
  email: string;
  role: 'user' | 'merchant' | 'specialist' | 'admin';
  iat: number;
  exp: number;  // 7 å¤©å¾ŒéæœŸ
}
æ ¸å¿ƒ API ç«¯é»
èªè­‰
Method	Endpoint	èªªæ˜	éœ€èªè­‰
POST	/api/auth/apple	Apple ç™»å…¥	âŒ
GET	/api/auth/user	å–å¾—ç•¶å‰ç”¨æˆ¶	âœ…
POST	/api/auth/logout	ç™»å‡º	âœ…
æ‰­è›‹ (Gacha) â­ æ ¸å¿ƒåŠŸèƒ½
Method	Endpoint	èªªæ˜	éœ€èªè­‰
POST	/api/gacha/itinerary/v3	æŠ½å–è¡Œç¨‹	âœ…
GET	/api/gacha/quota	æŸ¥è©¢æ¯æ—¥å‰©é¤˜é¡åº¦	âœ…
èƒŒåŒ… (Inventory)
Method	Endpoint	èªªæ˜	éœ€èªè­‰
GET	/api/inventory	åˆ—å‡ºèƒŒåŒ…ç‰©å“	âœ…
POST	/api/inventory/add	åŠ å…¥ç‰©å“	âœ…
DELETE	/api/inventory/:id	ç§»é™¤ç‰©å“	âœ…
GET	/api/inventory/count	ç‰©å“æ•¸é‡	âœ…
åœ°å€
Method	Endpoint	èªªæ˜	éœ€èªè­‰
GET	/api/countries	åœ‹å®¶åˆ—è¡¨	âŒ
GET	/api/regions/:countryId	ç¸£å¸‚åˆ—è¡¨	âŒ
GET	/api/districts/:regionId	å€åŸŸåˆ—è¡¨	âŒ
é€šçŸ¥
Method	Endpoint	èªªæ˜	éœ€èªè­‰
GET	/api/notifications	é€šçŸ¥åˆ—è¡¨	âœ…
POST	/api/notifications/:id/read	æ¨™è¨˜å·²è®€	âœ…
POST	/api/notifications/read-all	å…¨éƒ¨å·²è®€	âœ…
å„ªæƒ åˆ¸
Method	Endpoint	èªªæ˜	éœ€èªè­‰
GET	/api/coupons/my	æˆ‘çš„å„ªæƒ åˆ¸	âœ…
è¨­å®š
Method	Endpoint	èªªæ˜	éœ€èªè­‰
GET	/api/config/mapbox	Mapbox Token	âŒ
æ ¸å¿ƒ API è©³ç´°è¦æ ¼
æ‰­è›‹æŠ½å– V3 â­
// è«‹æ±‚
POST /api/gacha/itinerary/v3
Headers: { Authorization: Bearer <token> }
Body: {
  regionId: number;       // ç¸£å¸‚ ID (å¿…å¡«)
  itemCount?: number;     // æŠ½å–æ•¸é‡ 1-15ï¼Œé è¨­ 7
}
// å›æ‡‰
{
  success: boolean;
  places: Array<{
    id: number;
    placeName: string;
    city: string;
    district: string;
    category: string;      // é£Ÿã€éŠã€è³¼ã€å®¿ã€è¡Œ
    address?: string;
    locationLat?: number;
    locationLng?: number;
    googleRating?: number;
  }>;
  couponsWon: Array<{
    id: number;
    title: string;
    rarity: 'R' | 'S' | 'SR' | 'SSR' | 'SP';
  }>;
  meta: {
    city: string;
    anchorDistrict: string;
    totalPlaces: number;
    dailyPullCount: number;
    remainingQuota: number;
  };
}
// éŒ¯èª¤å›æ‡‰
{
  success: false;
  error: "ä»Šæ—¥æŠ½å¡æ¬¡æ•¸å·²é”ä¸Šé™ï¼Œè«‹æ˜å¤©å†ä¾†ï¼";
  code: "DAILY_LIMIT_EXCEEDED";
  remainingQuota: 0;
}
æ¯æ—¥é¡åº¦æŸ¥è©¢
// è«‹æ±‚
GET /api/gacha/quota
Headers: { Authorization: Bearer <token> }
// å›æ‡‰
{
  dailyLimit: 36;
  currentCount: 12;
  remainingQuota: 24;
}
TypeScript Interface
// ç”¨æˆ¶
interface User {
  id: string;
  email: string;
  firstName?: string;
  lastName?: string;
  role: 'user' | 'merchant' | 'specialist' | 'admin';
  profileImageUrl?: string;
}
// æ™¯é»
interface Place {
  id: number;
  placeName: string;
  city: string;
  district?: string;
  category: string;
  subcategory?: string;
  address?: string;
  locationLat?: number;
  locationLng?: number;
  googleRating?: number;
  googlePlaceId?: string;
}
// å„ªæƒ åˆ¸
interface Coupon {
  id: number;
  title: string;
  description?: string;
  discountType: 'percentage' | 'fixed' | 'freebie';
  discountValue: number;
  rarity: 'R' | 'S' | 'SR' | 'SSR' | 'SP';
  validFrom: string;
  validUntil: string;
  code: string;
}
// èƒŒåŒ…ç‰©å“
interface InventoryItem {
  id: number;
  itemType: 'place' | 'coupon';
  itemId: number;
  addedAt: string;
  expiresAt?: string;
  isUsed: boolean;
  // é—œè¯è³‡æ–™
  place?: Place;
  coupon?: Coupon;
}
// é€šçŸ¥
interface Notification {
  id: number;
  type: 'system' | 'coupon' | 'trip' | 'sos';
  title: string;
  body: string;
  isRead: boolean;
  createdAt: string;
}
// åœ°å€
interface Country {
  id: number;
  nameZh: string;
  nameEn: string;
  code: string;
}
interface Region {
  id: number;
  countryId: number;
  nameZh: string;
  nameEn: string;
}
interface District {
  id: number;
  regionId: number;
  nameZh: string;
  nameEn: string;
}
éŒ¯èª¤è™•ç†
éŒ¯èª¤æ ¼å¼
interface ApiError {
  error: string;      // äººé¡å¯è®€è¨Šæ¯
  code?: string;      // æ©Ÿå™¨å¯è®€ä»£ç¢¼
  details?: any;
}
å¸¸è¦‹éŒ¯èª¤ç¢¼
HTTP	Code	èªªæ˜	å‰ç«¯è™•ç†
401	UNAUTHORIZED	æœªç™»å…¥æˆ– Token éæœŸ	å°å‘ç™»å…¥é 
403	FORBIDDEN	ç„¡æ¬Šé™	é¡¯ç¤ºæç¤º
429	DAILY_LIMIT_EXCEEDED	æ¯æ—¥æŠ½å¡å·²é”ä¸Šé™	é¡¯ç¤ºæ˜å¤©å†ä¾†
400	REGION_NOT_FOUND	æ‰¾ä¸åˆ°å€åŸŸ	é‡æ–°é¸æ“‡
200	NO_PLACES_AVAILABLE	è©²å€åŸŸç„¡æ™¯é»	é¡¯ç¤ºæç¤º
éŒ¯èª¤è™•ç†ç¯„ä¾‹
const handleApiError = (response: Response, data: any) => {
  if (response.status === 401) {
    // Token éæœŸï¼Œé‡æ–°ç™»å…¥
    logout();
    return;
  }
  
  if (data.code === 'DAILY_LIMIT_EXCEEDED') {
    Alert.alert('ä»Šæ—¥é¡åº¦å·²ç”¨å®Œ', 'è«‹æ˜å¤©å†ä¾†æŠ½å¡ï¼');
    return;
  }
  
  if (data.code === 'NO_PLACES_AVAILABLE') {
    Alert.alert('ç›®å‰ç„¡æ™¯é»', data.meta?.message || 'è«‹é¸æ“‡å…¶ä»–å€åŸŸ');
    return;
  }
  
  // é€šç”¨éŒ¯èª¤
  Alert.alert('ç™¼ç”ŸéŒ¯èª¤', data.error || 'è«‹ç¨å¾Œå†è©¦');
};
åˆ†é åƒæ•¸
// è«‹æ±‚
GET /api/xxx?page=1&limit=20
// å›æ‡‰
{
  data: T[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  }
}
é‡è¦æ•¸å€¼
é …ç›®	å€¼
æ¯æ—¥æŠ½å¡ä¸Šé™	36 æ¬¡
èƒŒåŒ…å®¹é‡	30 æ ¼
JWT æœ‰æ•ˆæœŸ	7 å¤©
å„ªæƒ åˆ¸ç¨€æœ‰åº¦	R (32%), S (23%), SR (15%), SSR (8%), SP (2%)